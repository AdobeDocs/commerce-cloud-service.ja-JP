---
title: キャッシュ設定のカスタマイズ
description: Fastly サービスのセットアップが完了した後に、キャッシュ設定を確認しカスタマイズする方法を説明します。
feature: Cloud, Configuration, Iaas, Cache
exl-id: f1fc85d4-7867-4bb5-9f11-bc8d2d80383b
source-git-commit: 8a0523f1714b6ea41887e99b5c31294cf5e5255e
workflow-type: tm+mt
source-wordcount: '1808'
ht-degree: 0%

---

# キャッシュ設定のカスタマイズ

ステージング環境と実稼動環境で Fastly サービスを設定およびテストした後は、キャッシュ設定を確認し、カスタマイズします。 例えば、設定を更新して、TLS が HTTP 要求を Fastly にリダイレクトするように強制する、パージ設定を更新する、開発時にサイトをパスワードで保護するために基本認証を有効にするなどを行うことができます。

次の節では、キャッシュ設定の概要と設定方法について説明します。 使用可能な設定オプションに関する追加情報は、にあります。 [Magento 2 用 Fastly CDN モジュール](https://github.com/fastly/fastly-magento2/tree/master/Documentation) ドキュメント。

## TLS を強制

Fastly では、次のものを提供しています _TLS を強制_ 暗号化されていないリクエスト（HTTP）を Fastly にリダイレクトするオプションが追加されました。 ステージング環境または実稼動環境にがプロビジョニングされた後 [有効な SSL/TLS 証明書](fastly-configuration.md#provision-ssltls-certificates)を選択する場合は、ストアの Fastly 設定を更新して、「TLS を強制」オプションを有効にできます。 Fastly を見る [TLS 強制ガイド](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/FORCE-TLS.md) が含まれる _Magento 2 用 Fastly CDN モジュール_ ドキュメント。

>[!NOTE]
>
>クラウドインフラストラクチャストア上のAdobe Commerceでは、「TLS を強制」オプションの有効化がベストプラクティスとして推奨されます。

## Fastly 拡張タイムアウト

Fastly サービス設定では、管理者への HTTPS リクエストに対してデフォルトのタイムアウト期間である 180 秒を指定しています。 タイムアウト期間を超えるリクエスト処理は、503 エラーを返します。 その結果、長い処理が必要なリクエストに応答したり、一括操作を実行しようとすると、503 エラーが発生する場合があります。

3 分以上かかる一括アクションを完了するには、を変更します _管理パスのタイムアウト_ value_を指定すると、503 エラーを回避できます。

>[!NOTE]
>
>Fastly UI で管理者以外の Fastly タイムアウトパラメーターを拡張するには、を参照してください。 [長いジョブのタイムアウトを増やす](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/Edge-Modules/EDGE-MODULE-INCREASE-TIMEOUTS-LONG-JOBS.md).

**管理者の Fastly タイムアウトを拡張するには**:

{{admin-login-step}}

1. クリック **ストア** > 設定 > **設定** > **詳細** > **システム** を展開します **フルページキャッシュ**.

1. が含まれる _Fastly 設定_ セクション、展開 **詳細設定**.

1. を **管理パスのタイムアウト** 秒単位の値。 この値は、10 分（600 秒）を超えることはできません。

1. クリック **設定を保存** ページの上部

1. ページの再読み込み後、 **Fastly への VCL のアップロード** が含まれる _Fastly 設定_ セクション。

Fastly は、 `app/etc/env.php` 設定ファイル。

## パージオプションを設定

Fastly では、Magentoカテゴリ、商品アセット、コンテンツをパージするオプションなど、複数のタイプのパージオプションを商品キャッシュ管理ページで提供しています。 有効にすると、Fastly はこれらのキャッシュを自動的にパージするイベントを監視します。 パージオプションを無効にした場合は、キャッシュ管理ページで更新を完了した後に、Fastly キャッシュを手動でパージできます。

パージのオプションには次のものがあります。

- **カテゴリのパージ**-1 つの製品を追加および更新すると、（製品コンテンツではなく）製品カテゴリコンテンツがパージされます。 この機能を無効のままにして、「製品をパージ」を有効にすると、製品と製品カテゴリがパージされます。
- **製品をパージ** – 製品に対する 1 つの変更を保存するときに、すべての製品および製品カテゴリコンテンツをパージします。 製品のパージを有効にすると、価格の変更、製品オプションの追加、製品在庫が在庫切れになったときに、顧客にすぐにアップデートを送信できます。
- **CMS ページをパージ**- Adobe Commerce CMS にページを更新および追加すると、ページコンテンツがパージされます。 例えば、利用規約や返品ポリシーを更新する際にパージすることができます。 これらの変更をほとんど行わない場合は、自動パージを無効にすることができます。
- **ソフトパージ** – 変更されたコンテンツを古いものに設定し、古くなったタイミングに従って消去します。 古いタイミングに加えて、顧客には古いコンテンツが配信されるのに対して、Fastly はバックグラウンドでコンテンツを更新します。

![パージオプションを設定](../../assets/cdn/fastly-purge-options.png)

**Fastly パージオプションを設定するには**:

1. が含まれる _Fastly 設定_ セクション、展開 **詳細設定** パージ オプションを表示します。

1. 消去オプションごとに、次の項目を選択します **はい** 自動パージを有効にするには、または **不可** 自動パージを無効にする。

   パージ オプションを無効にした場合は、そのカテゴリのキャッシュを手動で次の場所からパージする必要があります _キャッシュ管理_ ページ。

1. クリック **設定を保存** ページの上部

1. ページの再読み込み後、 **Fastly への VCL のアップロード** が含まれる _Fastly 設定_ セクション。

詳しくは、を参照してください [fastly 設定オプション](https://github.com/fastly/fastly-magento2/blob/21b61c8189971275589219d418332798efc7db41/Documentation/CONFIGURATION.md#further-configuration-options).

## GeoIP 処理の設定

Fastly モジュールには、訪問者を自動的にリダイレクトする GeoIP 処理や、取得した国コードに一致するストアのリストを提供する GeoIP 処理が含まれています。 GeoIP 処理に既に拡張機能を使用している場合は、Fastly オプションで機能を検証する必要がある場合があります。

**GeoIp 処理を設定するには**:

{{admin-login-step}}

1. クリック **ストア** > 設定 > **設定** > **詳細** > **システム** を展開します **フルページキャッシュ**.

1. が含まれる _Fastly 設定_ セクション、展開 **詳細設定**.

1. 下にスクロールして選択 **はい** 対象： **GeoIP を有効にする**. 追加の設定オプションが表示されます。

1. 「GeoIP アクション」で、訪問者が次のアドレスで自動的にリダイレクトされるかどうかを選択します **リダイレクト** または、から選択するストアのリストが提供されました **ダイアログ**.

1. の場合 **国マッピング**&#x200B;を選択 **追加** リスト内の特定のAdobe Commerce ストアにマッピングする 2 文字の国コードを入力します。

   ![GeoIP 国マップの追加](/help/assets/cdn/fastly-geo-code.png)

1. クリック **設定を保存** ページの上部

1. ページの再読み込み後、を選択します。 **Fastly への VCL のアップロード** が含まれる _Fastly 設定_ セクション。

>[!NOTE]
>
>現在のAdobe Commerce Fastly GeoIP モジュールの実装では、複数の web サイト間のリダイレクトをサポートしていません。

Fastly では、次のシリーズも提供しています。 [位置情報に関連する VCL 機能](https://developer.fastly.com/reference/vcl/variables/geolocation/) カスタマイズされた位置情報コーディングの場合。

## Fastly エッジモジュールの有効化

Fastly エッジモジュールは、テンプレートを使用して UI コンポーネントおよび関連する VCL コードを定義できる柔軟なフレームワークです。 これらのモジュールを使用すると、カスタム VCL スニペットを使用する代わりに、ユーザーインターフェイスを通じて Fastly サービス設定を簡単にカスタマイズおよび拡張できます。

エッジモジュールを使用すると、CORS ヘッダー、Cloud Sitemap の書き換えなどの特定の機能を有効にしたり、Adobe Commerce ストアと他の CMS またはバックエンドとの統合を設定したりできます。

エッジモジュール メニューにアクセスして使用可能なモジュールを表示、設定、管理するには、をオンにします _Fastly エッジモジュールの有効化_ オプション。 参照： [Fastly エッジモジュール](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/Edge-Modules/EDGE-MODULES.md) Fastly CDN モジュールのドキュメントを参照してください。

## バックエンドとオリジン シールドの設定

バックエンド設定では、オリジンのシールドとタイムアウトを使用して、Fastly パフォーマンスの微調整を行います。 A _バックエンド_ は、キャッシュされたコンテンツを確認して提供するために設定されたオリジンシールドおよびタイムアウト設定を持つ特定の場所（IP またはドメイン）です。

_原点シールド_ ストアに対するすべてのリクエストを、特定の POP （Point of Presence）にルーティングします。 リクエストを受信すると、POP はキャッシュされたコンテンツをチェックし、提供します。 キャッシュされていない場合、データは Shield POP に引き続き送信され、その後、コンテンツをキャッシュするオリジンサーバーに送信されます。 シールドは、接触チャネルへの直接トラフィックを減らします。

デフォルトの Fastly VCL コードは、クラウドインフラストラクチャサイト上のAdobe Commerceのオリジンシールドとタイムアウトのデフォルト値を指定します。 場合によっては、デフォルト値の変更が必要になることがあります。 たとえば、Time to First Byte （TTFB）エラーが発生している場合、 _最初のバイトのタイムアウト_ の値。

>[!NOTE]
>
>サイトがのようなバックエンド統合を通じて機能的に配信される必要がある場合 [Wordpress](fastly-vcl-wordpress.md)を追加し、Adobe Commerce ストアから Wordpress へのリダイレクトを管理します。 詳しくは、を参照してください [Fastly エッジモジュール – その他の CMS/バックエンド統合](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/Edge-Modules/EDGE-MODULE-OTHER-CMS-INTEGRATION.md) Fastly モジュールのドキュメントを参照してください。

**バックエンド設定の設定を確認するには：**:

{{admin-login-step}}

1. クリック **ストア** > 設定 > **設定** > **詳細** > **システム** を展開します **フルページキャッシュ**.

1. を展開します。 **Fastly 設定** セクション。

1. を展開 **バックエンド設定** そして、歯車を選択して、デフォルトのバックエンドを確認します。 現在の設定を変更するオプションを含むモーダルが開きます。

   ![バックエンドの変更](../../assets/cdn/fastly-backend.png)

1. 「」を選択します **シールド** 場所（またはデータセンター）

   プロジェクトのデフォルトの Fastly 設定では、Cloud Service 地域に最も近い場所が設定されます。 変更が必要な場合は、デフォルトの場所に近い場所を選択します。

1. シールドへの接続のタイムアウト値（マイクロ秒単位）、バイト間の時間、最初のバイトの時間を変更します。 デフォルトのタイムアウト設定を維持することをお勧めします。

1. 必要に応じて、を選択します **編集または保存後にバックエンドとシールドをアクティベート**.

1. クリック **Upload** 変更を保存し、Fastly サーバーにアップロードします。

1. 管理者で、を選択します。 **設定を保存**.

詳しくは、 [バックエンド設定ガイド](https://github.com/fastly/fastly-magento2/blob/21b61c8189971275589219d418332798efc7db41/Documentation/Guides/BACKEND-SETTINGS.md) Fastly モジュールのドキュメントを参照してください。

## 基本認証

基本認証は、サイト上のすべてのページとアセットをユーザー名とパスワードで保護する機能です。 We **推奨しない** 実稼動環境での基本認証の有効化。 ステージング環境で設定して、開発プロセス中にサイトを保護できます。 を参照してください。 [基本認証ガイド](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/BASIC-AUTH.md) Fastly CDN モジュールのドキュメントを参照してください。

ユーザーアクセスを追加し、ステージングで基本認証を有効にした場合でも、追加の資格情報を必要とせずに管理者にアクセスできます。

## カスタム VCL スニペットの作成

Fastly では、Fastly サービス設定をカスタマイズするために、Varnish Configuration Language （VCL）のカスタマイズバージョンをサポートしています。 例えば、エッジおよびアクセス制御リスト （ACL）辞書を持つ VCL コードブロックを使用して、特定のユーザーまたは IP アドレスに対するアクセスを許可、ブロック、またはリダイレクトできます。

カスタム VCL スニペット、エッジ辞書、および ACL の作成手順については、を参照してください。 [カスタム Fastly VCL スニペット](fastly-vcl-custom-snippets.md).

>[!NOTE]
>
>カスタム VCL コード、エッジ辞書、ACL を Fastly モジュール設定に追加する前に、Fastly キャッシュサービスがデフォルト設定で機能することを確認してください。 参照： [Fastly の設定](fastly-configuration.md).

## ドメインの管理

スタータープロジェクトと Pro プロジェクトの両方で、を使用できます [!UICONTROL Domains] ストアの Fastly ドメイン設定を追加および管理するオプション。

- スタータープロジェクトの場合は、の下のプロジェクト URL に移動します。 [!UICONTROL Domains] タブ [!DNL Cloud Console] プロジェクト URL を追加します。

- Pro プロジェクトの場合は、次を送信 [Adobe Commerce サポートチケット](https://experienceleague.adobe.com/docs/commerce-knowledge-base/kb/help-center-guide/magento-help-center-user-guide.html#submit-ticket) をクリックして、ドメインをクラウドプロジェクト設定に追加します。 また、サポートチームは、Adobe Commerce Fastly アカウント設定を更新して、ドメインを追加します。

**管理者から Fastly ドメイン設定を管理するには**:

{{admin-login-step}}

1. を選択 **ストア** > 設定 > **設定** > **詳細** > **システム** を展開します **フルページキャッシュ**.

1. 管理画面 _Fastly 設定_ セクションで選択 **ドメイン**.

1. クリック **ドメインの管理** をクリックして、ドメイン ページを開きます。

1. クラウド環境のストアの最上位およびサブドメイン名を追加します。

   指定できるのは、クラウドインフラストラクチャ設定に既に追加されているドメインのみです。

   ![スターター用 Fastly ドメイン設定の追加](../../assets/cdn/fastly-starter-activate-domain.png)

1. クリック **Activate** をクリックして、Fastly ドメイン設定を更新します。

>[!NOTE]
>
>同じドメインが異なる Fastly アカウントで設定されている場合、ドメインをAdobe Commerceに追加する前に、Adobe Commerce サポートチケットを送信してドメインデリゲーションをリクエストする必要があります。 参照： [複数の Fastly アカウントと割り当てられたドメイン](fastly.md#multiple-fastly-accounts-and-assigned-domains).

## メンテナンスモードの有効化

の使用 _メンテナンスモード_ 他のすべてのリクエストに対してエラーページを返す際に、指定した IP アドレスからサイトへの管理アクセスを許可するオプション。

**管理アクセス権を持つメンテナンスモードを有効にするには**:

1. を開きます _Fastly 設定_ 」セクションを選択します。

1. が含まれる _エッジ ACL_ セクションで、 `maint_allow` メンテナンスモード中にストアにアクセスできる管理 IP アドレスを含むアクセス制御リスト（ACL）。

   ![IP メンテナンスモード許可リストの更新](../../assets/cdn/fastly-maint-allowlist.png)

1. が含まれる _メンテナンスモード_ セクションで選択 **メンテナンスモードの有効化**.

   メンテナンスモードを有効にすると、内の IP アドレスからのリクエストを除き、すべてのトラフィックがブロックされます。 `maint_allowlist` ACL。 を更新できます `maint_allowlist` ACL の IP アドレスを変更します。

   設定手順について詳しくは、 [メンテナンスモードガイド](https://github.com/fastly/fastly-magento2/blob/master/Documentation/Guides/MAINTENANCE-MODE.md) （Magento 2 モジュール用 Fastly CDN ドキュメント）を参照してください。
