---
title: デプロイメントのベストプラクティス
description: クラウドインフラストラクチャにAdobe Commerceをデプロイする際のベストプラクティスについて説明します。
feature: Cloud, Deploy, Best Practices
exl-id: bac3ca83-0eee-4fda-9a5c-a84ab25a837a
source-git-commit: eace5d84fa0915489bf562ccf79fde04f6b9d083
workflow-type: tm+mt
source-wordcount: '1904'
ht-degree: 0%

---

# デプロイメントのベストプラクティス

ビルドおよびデプロイスクリプトは、コードをリモート環境に結合する際にアクティベートされます。 これらのスクリプトは環境を使用します [設定ファイル](../environment/overview.md) 適切なデータとサービスでクラウドインフラストラクチャをプロビジョニングするためのアプリケーションコード。 また、これらのスクリプトは、クラウド環境でAdobe Commerce アプリケーション、サードパーティのサービスおよびカスタム拡張機能をインストールまたは更新するために使用されます。

ビルドとデプロイのプロセスは、計画ごとに少し異なります。

- **スタータープラン** – 統合環境の場合、アクティブなすべてのブランチが、アクセスとテスト用に完全な環境を構築およびデプロイします。 に結合した後のコードの完全なテスト `staging` 分岐。 サイトを起動するには、をプッシュします `staging` 対象： `master` を実稼動環境にデプロイします。 経由ですべてのブランチへのフルアクセス権を持っています [!DNL Cloud Console] と CLI コマンドを使用します。

- **Pro プラン** – 統合環境の場合、アクティブなすべてのブランチが、アクセスとテスト用に完全な環境を構築およびデプロイします。 コードのへの結合 `integration` ステージング環境と実稼動環境に結合する前に分岐します。 を使用してステージング環境と実稼動環境に結合できます。 [!DNL Cloud Console] または SSH を使用して `magento-cloud` CLI コマンド。

## プロセスのトラッキング

ターミナルまたはを使用して、ビルドおよびデプロイのアクションをリアルタイムで追跡できます。 [!DNL Cloud Console] ステータス・メッセージ：`in-progress`, `pending`, `success`、または `failed`- デプロイメントプロセス中に表示されます。 ログファイルに詳細を表示できます。 参照： [ログを表示](../test/log-locations.md).

外部 GitHub リポジトリを使用している場合、操作のログは GitHub セッションに表示されません。 ただし、外部リポジトリとのインターフェイスでアクティビティに従うことは可能です [!DNL Cloud Console]. 参照： [統合](../integrations/overview.md).

>[!NOTE]
>
>統合環境では、からデプロイログを表示することはできません [!DNL Cloud Console]. この機能は、実稼動環境とステージング環境でのみ使用できます。 ただし、次を使用すれば、どの環境でも、デプロイメントの各フェーズのログを表示できます [ビルドとデプロイ](../test/log-locations.md#build-and-deploy-logs) ログ。 トラブルシューティング情報については、を参照してください [デプロイメントエラーリファレンス](../dev-tools/error-reference.md).

を有効にできます [New Relicを使用したデプロイメントの追跡](../monitor/track-deployments.md) デプロイメントのイベントを監視し、デプロイメント間のパフォーマンスを分析します。

## ビルドとデプロイメントのベストプラクティス

デプロイメントプロセスに関する以下のベストプラクティスと考慮事項を確認します。

- **の最新バージョンを実行していることを確認してください `ece-tools` package**

  参照： [ECE-Tools のリリースノート](../release-notes/ece-tools-package.md).

- **ビルドおよびデプロイプロセスに従います**

  環境間でコードを結合する際に設定が上書きされるのを避けるために、各環境に正しいコードが用意されていることを確認します。 例えば、設定の変更をすべての環境に適用するには、リモート統合環境にデプロイする前に、ローカル環境で変更を変更およびテストします。 次に、実稼動環境にデプロイする前に、ステージング環境で変更をデプロイしてテストします。 ある環境から別の環境に結合すると、環境固有の設定を除き、デプロイメントによって環境内のすべてのコードが上書きされます。

- **環境全体で同じ変数を使用します**

  これらの変数の値は、環境によって異なる場合があります。ただし、通常は各環境で同じ変数が必要です。 参照： [ストア設定の設定管理](../store/store-settings.md).

- **環境固有の変数に機密性の高い設定値とデータを保持**

  これらの値には、Cloud CLI を使用して指定された変数、 [!DNL Cloud Console]、またはに追加しました `env.php` ファイル。 参照： [変数レベル](../environment/variable-levels.md).

- **環境ブランチですべてのコードが使用可能であることを確認します**

  プライベートブランチなどの他のブランチからコードを参照すると、ビルドおよびデプロイプロセス中に問題が発生する可能性があります。 例えば、非公開ブランチからテーマを参照する場合、テーマにはアクセスできず、アプリケーションコードを使用してテーマを作成することもできません。

- **反復されたブランチへの拡張機能、統合およびコードの追加**

  変更をローカルで行ってテストし、にプッシュします。 `integration`、次に `staging` および `production`. 更新を次の環境に結合する前に、各環境の問題をテストして解決します。 一部の拡張機能と統合は、依存関係により、特定の順序で有効にして設定する必要があります。 グループで追加とテストを行うと、ビルドとデプロイのプロセスがはるかに容易になり、問題が発生する場所を判断するのに役立ちます。

- **サービスのバージョンと関係、および接続機能を確認する**

  アプリケーションで使用可能なサービスを確認し、最新の互換性のあるバージョンを使用していることを確認します。 参照： [サービスの関係](../services/services-yaml.md#service-relationships) および [必要システム構成](https://experienceleague.adobe.com/docs/commerce-operations/installation-guide/system-requirements.html) が含まれる _インストールガイド_ （推奨バージョン用）。

- **ステージング環境および実稼動環境にデプロイする前に、ローカルおよび統合環境でテストします**

  ステージング環境および実稼動環境にデプロイする際にダウンタイムが長くならないように、ローカル環境と統合環境の問題を特定し修正します。

  >[!TIP]
  >
  >次のものがあります [スマート ウィザード](../deploy/smart-wizards.md) クラウドプロジェクトの設定が、静的コンテンツのデプロイメント（SCD）戦略を含む、ビルドおよびデプロイメント設定のベストプラクティスに従っていることを確認するために使用できるコマンド。

- **ローカル環境と統合環境でのテストが完了したら、ステージング環境でデプロイしてテストします**

  参照： [ステージングと実稼動のテスト](../test/staging-and-production.md).

- **実稼動環境の設定の確認**

  実稼動環境にデプロイする前に、次のタスクを実行します。

   - を使用して、実稼動環境の 3 つのノードすべてに接続できることを確認します。 [SSH](../development/secure-connections.md).

   - インデクサーがに設定されていることを確認 _スケジュールに従って更新_. 参照： [インデックス作成モード](https://developer.adobe.com/commerce/php/development/components/indexing/) が含まれる _拡張機能デベロッパーガイド_.

   - 実稼動コードで環境固有の変数を更新し、サービスの可用性と互換性を確認し、その他の必要な設定変更を行って、環境を準備します。

- **デプロイプロセスの監視**

  デプロイメントステータスメッセージを確認し、必要に応じて問題を軽減します。 クラウドのレビュー [ログ](../test/log-locations.md#) を参照してください。

## 統合のビルドとデプロイメントの 5 つのフェーズ

統合環境およびローカル開発環境では、次のフェーズが行われます。 Pro プランの場合、これらの初期フェーズでは、コードはステージング環境または実稼動環境にデプロイされません。

### フェーズ 1：コードと設定の検証

プロジェクトの初回設定時、 [クラウドインフラストラクチャテンプレート](https://github.com/magento/magento-cloud) コードファイルの基礎を提供します。 このコードリポジトリーは、としてプロジェクトに複製されます `master` 分岐。

- **スターターの場合**—`master` ブランチは実稼動環境です。
- **プロの場合**—`master` 統合環境のオリジンブランチとして開始します。

から分岐を作成します `master` カスタムコード、拡張機能およびモジュール、サードパーティ統合の場合。 クラウド内のコードをテストするためのリモート統合環境があります。

コードをローカルワークスペースからリモートリポジトリにプッシュすると、ビルドスクリプトとデプロイスクリプトの開始前に、一連のチェックとコード検証が完了します。 組み込みの Git サーバーが、プッシュ内容の検証と変更を行います。 例えば、OpenSearch サービスを追加すると、組み込みの Git サーバーによって、クラスターのトポロジが適切に変更されたかどうかが確認されます。

設定ファイルに構文エラーがある場合、Git サーバーはプッシュを拒否します。 参照： [保護ブロック](../development/protective-block.md).

このフェーズも実行されます `composer install` 依存関係を取得します。

### フェーズ 2：構築

>[!NOTE]
>
>ビルドフェーズでは、サイトはメンテナンスモードではなく、エラーや問題が発生しても停止しません。 前のビルド以降に変更されたコードのみをビルドします。

このフェーズでは、コードベースを構築し、 `build` セクション `.magento.app.yaml`. デフォルトのビルドフックはです。 `php ./vendor/bin/ece-tools` コマンドを実行し、次の操作を実行します。

- でパッチを適用します。 `vendor/magento/ece-patches`、およびのオプションのプロジェクト固有のパッチ `m2-hotfixes`
- コードとを再生成します [依存性の注入](https://experienceleague.adobe.com/docs/commerce-operations/operational-playbook/glossary.html) 設定（つまり、 `generated/` ディレクトリ（以下を含む） `generated/code` および `generated/metapackage`）使用 `bin/magento setup:di:compile`.
- 次の条件を満たしているかどうかを確認 [`app/etc/config.php`](../store/store-settings.md) ファイルはコードベースに存在します。 Adobe Commerceは、ビルドフェーズでこのファイルが検出されず、モジュールと拡張機能のリストが含まれている場合、このファイルを自動生成します。 存在する場合、ビルドフェーズは通常どおり続行され、静的ファイルは GZIP で圧縮されてデプロイされるので、デプロイメントフェーズでのダウンタイムが短縮されます。 こちらを参照してください [ビルドオプション](../environment/variables-build.md) で、ファイル圧縮のカスタマイズまたは無効化について説明します。

>[!WARNING]
>
>この時点では、クラスタは作成されていないので、データベースに接続しようとしたり、アクティブなデーモンプロセスがあると仮定したりしないでください。

アプリケーションのビルド後、そのアプリケーションは **読み取り専用ファイルシステム**. 読み取り/書き込み可能にする特定のマウントポイントを設定できます。 サーバーに FTP で接続したり、モジュールを追加したりすることはできません。 代わりに、ローカルリポジトリにコードを追加して実行する必要があります `git push`環境をビルドおよびデプロイします。 プロジェクト構造については、を参照してください。 [ローカルプロジェクトディレクトリ構造](../project/file-structure.md).

### フェーズ 3：スラグを準備する

構築フェーズの結果、と呼ばれる読み取り専用のファイルシステムが生成されます。 _スラッグ_. このフェーズでは、アーカイブが作成され、スラグが永続的なストレージに配置されます。 次回コードをプッシュするときに、サービスが変更されなかった場合は、アーカイブのスラグが使用されます。

- 変更されていないコードを再利用することで、継続的な統合ビルドを迅速に実行
- コードが変更された場合、再利用するために次のビルド用にスラグを更新します
- 必要に応じて、デプロイメントを即座に元に戻すことができます。
- 静的ファイルを含める場合 `app/etc/config.php` ファイルはコードベースに存在します

見出しには、すべてのファイルとフォルダーが含まれます **次のものを除く** で設定されたマウント `magento.app.yaml`:

- `"var": "shared:files/var"`
- `"app/etc": "shared:files/etc"`
- `"pub/media": "shared:files/media"`
- `"pub/static": "shared:files/static"`

### フェーズ 4：スラグとクラスターのデプロイ

アプリケーションとすべて [バックエンド](https://experienceleague.adobe.com/docs/commerce-operations/operational-playbook/glossary.html) 次のようなサービスプロビジョニング：

- Web サーバー、OpenSearch などのコンテナ内の各サービスをマウントします。 [!DNL RabbitMQ]
- 読み取り/書き込み可能なファイル・システムをマウントする（高可用性の分散ストレージ・グリッドにマウント）
- サービスが相互に（そして互いに対してのみ）見ることができるようにネットワークを設定します。

>[!NOTE]
>
>すべてのビルドおよびデプロイメントが完了したら、Git ブランチで変更を行い、再度プッシュします。 すべての環境ファイル・システムは次のとおりです _読み取り専用_. 読み取り専用システムは、ファイルシステムに書き込みを行うプロセスがないため、決定的なデプロイメントを保証し、サイトのセキュリティを大幅に向上させます。 また、統合、ステージング、実稼動環境でもコードが同じであることを確認します。

### フェーズ 5：デプロイメントフック

>[!NOTE]
>
>このフェーズでは、 [!DNL Commerce] デプロイメントが完了するまで、アプリケーションはメンテナンスモードになります。

最後の手順では、デプロイメントスクリプトを実行します。このスクリプトを使用して、開発環境のデータの匿名化、キャッシュのクリア、外部の継続的統合ツールのクエリを行うことができます。 このスクリプトを実行すると、Redis などの環境内のすべてのサービスにアクセスできます。

次の場合 `app/etc/config.php` ファイルがコードベースに存在しません。静的ファイルは、を使用して圧縮されます。 `gzip` また、このフェーズで導入されるため、導入フェーズとサイトのメンテナンスの期間が長くなります。

>[!NOTE]
>
>こちらを参照してください [変数のデプロイ](../environment/variables-deploy.md) で、ファイル圧縮のカスタマイズまたは無効化について説明します。

デプロイフックは 2 つあります。 この `pre-deploy.php` フックは、ビルドフックで生成されたリソースとコードの必要なクリーンアップと取得を完了します。 この `php ./vendor/bin/ece-tools deploy` フックは、一連のコマンドとスクリプトを実行します。

- Adobe Commerceが **インストールされていません**。インストール先： `bin/magento setup:install`デプロイメント設定を更新し、 `app/etc/env.php`、および指定した環境用のデータベース（Redis や web サイト URL など）。 **重要：** を完了したとき [初回のデプロイメント](https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/launch/overview.html) セットアップ時に、Adobe Commerceはインストールされ、すべての環境にデプロイされました。

- Adobe Commerceの場合 **インストール済み**&#x200B;必要なアップグレードを実行します。 デプロイメントスクリプトが実行されます `bin/magento setup:upgrade` データベーススキーマとデータ（拡張機能またはコアコードの更新後に必要）を更新し、デプロイメント設定も更新するには、 `app/etc/env.php`、およびお使いの環境のデータベース。 最後に、デプロイメントスクリプトによって Adobe Commerceのキャッシュがクリアされます。

- スクリプトはオプションで、コマンドを使用して静的 web コンテンツを生成します `magento setup:static-content:deploy`.

- 範囲を使用（`-s` デフォルト設定がのビルドスクリプト内のフラグ `quick` 静的コンテンツのデプロイメント戦略の場合。 環境変数を使用して、戦略をカスタマイズできます [`SCD_STRATEGY`](../environment/variables-deploy.md#scd_strategy). これらのオプションと機能について詳しくは、を参照してください [静的ファイルのデプロイメント戦略](../deploy/static-content.md) および `-s` のフラグ [静的表示ファイルのデプロイ](https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cli/static-view/static-view-file-deployment.html).

>[!NOTE]
>
>デプロイスクリプトでは、の設定ファイルで定義された値を使用します。 `.magento` 次に、スクリプトはディレクトリとその内容を削除します。 ローカル開発環境は影響を受けません。

### デプロイメント後：ルーティングの設定

デプロイメントの実行中、プロセスはエントリポイントでの受信トラフィックを 60 秒間停止し、新しく作成したクラスターに web トラフィックが到達するようにルーティングを再設定します。

デプロイメントが成功すると、メンテナンスモードが削除され、通常のアクセスが可能になり、のバックアップ（BAK）ファイルが作成されます。 `app/etc/env.php` および `app/etc/config.php` 設定ファイル。

を使用した静的コンテンツ生成の有効化 `SCD_ON_DEMAND` 変数と設定 [`post_deploy` フック](../application/hooks-property.md) キャッシュをクリアし、キャッシュをプリロード（warms）する _後_ コンテナが接続の受け入れを開始し、 _次の期間_ 通常の受信トラフィック。

ビルドおよびデプロイのログを確認するには、を参照してください [ログを表示](../test/log-locations.md#view-and-manage-logs).
