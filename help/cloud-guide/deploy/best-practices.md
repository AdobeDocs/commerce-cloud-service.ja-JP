---
title: デプロイメントのベストプラクティス
description: クラウドインフラストラクチャにAdobe Commerceをデプロイするためのベストプラクティスを確認します。
feature: Cloud, Deploy, Best Practices
exl-id: bac3ca83-0eee-4fda-9a5c-a84ab25a837a
source-git-commit: eace5d84fa0915489bf562ccf79fde04f6b9d083
workflow-type: tm+mt
source-wordcount: '1904'
ht-degree: 0%

---

# デプロイメントのベストプラクティス

コードをリモート環境に結合する際に、スクリプトを作成してデプロイします。 これらのスクリプトは環境を使用します [設定ファイル](../environment/overview.md) クラウドインフラストラクチャに適切なデータとサービスをプロビジョニングするためのアプリケーションコード。 また、これらのスクリプトは、クラウド環境でAdobe Commerceアプリケーション、サードパーティのサービス、カスタム拡張機能をインストールまたは更新するために使用されます。

ビルドとデプロイのプロセスは、プランごとに少し異なります。

- **スタータープラン** — 統合環境の場合、すべてのアクティブなブランチが、アクセスとテストのために完全な環境にビルドおよびデプロイされます。 に結合した後で、コードを完全にテストする `staging` 分岐。 サイトを起動するには、をプッシュします。 `staging` から `master` を使用して、実稼動環境にデプロイします。 すべてのブランチに対して、 [!DNL Cloud Console] CLI コマンド

- **プロプラン** — 統合環境の場合、すべてのアクティブなブランチが、アクセスとテストのために完全な環境にビルドおよびデプロイされます。 コードを `integration` ブランチを使用してから、ステージング環境と実稼動環境にマージします。 を使用して、ステージング環境と実稼動環境に結合できます。 [!DNL Cloud Console] または SSH とを使用して `magento-cloud` CLI コマンド。

## プロセスの追跡

ターミナルまたは [!DNL Cloud Console] ステータスメッセージ —`in-progress`, `pending`, `success`または `failed` — デプロイメントプロセス中に表示されます。 詳細は、ログファイルで確認できます。 詳しくは、 [ログを表示](../test/log-locations.md).

外部の GitHub リポジトリを使用している場合、操作のログは GitHub セッションに表示されません。 ただし、外部リポジトリと [!DNL Cloud Console]. 詳しくは、 [統合](../integrations/overview.md).

>[!NOTE]
>
>統合環境では、 [!DNL Cloud Console]. この機能は、実稼動環境とステージング環境でのみ使用できます。 ただし、 [ビルドとデプロイ](../test/log-locations.md#build-and-deploy-logs) ログ。 トラブルシューティングの情報については、 [デプロイメントエラーの参照](../dev-tools/error-reference.md).

次を有効にすることができます。 [New Relicを使用したデプロイメントの追跡](../monitor/track-deployments.md) デプロイメントイベントを監視し、デプロイメント間のパフォーマンスを分析する。

## ビルドとデプロイメントのベストプラクティス

デプロイメントプロセスに関する次のベストプラクティスと考慮事項を確認します。

- **最新バージョンの `ece-tools` パッケージ**

  詳しくは、 [ECE-Tools のリリースノート](../release-notes/ece-tools-package.md).

- **ビルドとデプロイのプロセスに従う**

  環境間でコードを結合する際に設定が上書きされないように、各環境に正しいコードが含まれていることを確認してください。 例えば、すべての環境に構成の変更を適用するには、リモート統合環境にデプロイする前に、ローカル環境で変更を変更し、テストします。 次に、ステージング環境で変更をデプロイしてテストしてから、実稼動環境にデプロイします。 ある環境から別の環境にマージすると、環境固有の設定と設定を除き、環境内のすべてのコードがデプロイメントによって上書きされます。

- **環境間で同じ変数を使用する**

  これらの変数の値は、環境間で異なる場合があります。ただし、通常、各環境で同じ変数が必要です。 詳しくは、 [ストア設定の構成管理](../store/store-settings.md).

- **環境固有の変数で、機密性の高い設定値とデータを保持する**

  これらの値には、Cloud CLI [!DNL Cloud Console]、または `env.php` ファイル。 詳しくは、 [変数レベル](../environment/variable-levels.md).

- **すべてのコードが環境ブランチで使用できることを確認します。**

  プライベートブランチなどの他のブランチからコードを参照すると、ビルドおよびデプロイプロセス中に問題が発生する可能性があります。 例えば、プライベートブランチからテーマを参照する場合、そのテーマにアクセスできず、アプリケーションコードを使用してテーマを構築することはできません。

- **繰り返し処理された分岐に拡張機能、統合、コードを追加する**

  ローカルで変更を行い、次にプッシュ `integration`を、を `staging` および `production`. アップデートを次の環境に結合する前に、各環境の問題をテストして解決してください。 一部の拡張機能と統合は、依存関係により、特定の順序で有効にして設定する必要があります。 グループに追加してテストすると、ビルドおよびデプロイのプロセスがより簡単になり、問題が発生する場所を判断するのに役立ちます。

- **サービスのバージョンと関係、および接続機能を検証**

  アプリケーションで使用可能なサービスを確認し、互換性のある最新バージョンを使用していることを確認します。 詳しくは、 [サービスの関係](../services/services-yaml.md#service-relationships) および [必要システム構成](https://experienceleague.adobe.com/docs/commerce-operations/installation-guide/system-requirements.html) （内） _インストールガイド_ を参照してください。

- **ステージングおよび実稼動環境にデプロイする前に、ローカルおよび統合環境でテストします。**

  ローカルおよび統合環境での問題を特定して修正し、ステージング環境および実稼動環境にデプロイする際の長時間のダウンタイムを防ぎます。

  >[!TIP]
  >
  >次のものがあります。 [スマートウィザード](../deploy/smart-wizards.md) クラウドプロジェクトの設定が、静的コンテンツデプロイメント (SCD) 戦略を含む、ビルドおよびデプロイメント設定のベストプラクティスに従っていることを検証するために使用できるコマンドです。

- **ローカルおよび統合環境でテストを完了したら、ステージング環境でデプロイおよびテストします。**

  詳しくは、 [ステージングと実稼動のテスト](../test/staging-and-production.md).

- **実稼動環境の設定を確認する**

  実稼動環境にデプロイする前に、次のタスクを実行します。

   - を使用して、実稼動環境の 3 つのノードすべてに接続できることを確認します。 [SSH](../development/secure-connections.md).

   - インデクサーが _スケジュールに従って更新_. 詳しくは、 [インデックス作成モード](https://developer.adobe.com/commerce/php/development/components/indexing/) （内） _拡張機能開発者ガイド_.

   - 実稼動コード内の環境固有の変数を更新し、サービスの可用性と互換性を検証し、その他の必要な設定変更をおこなって、環境を準備します。

- **デプロイプロセスの監視**

  デプロイメントステータスメッセージを確認し、必要に応じて問題を軽減します。 クラウドのレビュー [logs](../test/log-locations.md#) 詳細なログメッセージを参照してください。

## 統合のビルドとデプロイの 5 つの段階

次のフェーズは、ローカル開発環境と統合環境で発生します。 Pro プランの場合、コードは、これらの最初のフェーズでステージング環境または実稼動環境にデプロイされません。

### フェーズ 1：コードと設定の検証

プロジェクトを最初に設定したときは、 [クラウドインフラストラクチャテンプレート](https://github.com/magento/magento-cloud) は、コードファイルの基礎を提供します。 このコードリポジトリは、 `master` 分岐。

- **スターター用**—`master` branch は、実稼動環境です。
- **Pro の場合**—`master` は、統合環境の元のブランチとして開始されます。

からのブランチの作成 `master` カスタムコード、拡張機能とモジュール、サードパーティ統合に関する情報を含めることができます。 クラウド内のコードをテストするためのリモート統合環境があります。

ローカルワークスペースからリモートリポジトリにコードをプッシュすると、ビルドおよびデプロイスクリプトが開始する前に、一連のチェックとコード検証が完了します。 組み込みの Git サーバーが、プッシュ内容を検証し、変更をおこないます。 例えば、OpenSearch サービスを追加すると、組み込み Git サーバーは、クラスターのトポロジがそれに応じて変更されていることを確認します。

設定ファイルに構文エラーがある場合、Git サーバーはプッシュを拒否します。 詳しくは、 [保護ブロック](../development/protective-block.md).

このフェーズも実行されます `composer install` 依存関係を取得する。

### フェーズ 2：ビルド

>[!NOTE]
>
>ビルドフェーズでは、サイトはメンテナンスモードではなく、エラーや問題が発生した場合は停止しません。 以前のビルド以降に変更されたコードのみを構築します。

このフェーズでは、コードベースを構築し、 `build` のセクション `.magento.app.yaml`. デフォルトのビルドフックは、 `php ./vendor/bin/ece-tools` コマンドを実行し、次の操作を実行します。

- でパッチを適用 `vendor/magento/ece-patches`、およびのオプションのプロジェクト固有のパッチ `m2-hotfixes`
- コードを再生成し、 [依存注入](https://experienceleague.adobe.com/docs/commerce-operations/operational-playbook/glossary.html) 設定 ( `generated/` ディレクトリ ( `generated/code` および `generated/metapackage`) を使用 `bin/magento setup:di:compile`.
- 次の項目をチェックします。 [`app/etc/config.php`](../store/store-settings.md) ファイルがコードベース内に存在します。 ビルドフェーズでこのファイルが検出されず、モジュールと拡張子のリストが含まれている場合、Adobe Commerceはこのファイルを自動生成します。 存在する場合、ビルドフェーズは通常どおり続き、GZIP を使用して静的ファイルを圧縮してデプロイし、デプロイをおこなうので、デプロイメントフェーズのダウンタイムが短縮されます。 参照： [ビルドオプション](../environment/variables-build.md) ファイル圧縮のカスタマイズと無効化について説明します。

>[!WARNING]
>
>この時点では、クラスタは作成されていないので、データベースに接続しようとしたり、アクティブなデーモンプロセスがあると仮定したりしないでください。

アプリケーションがビルドされた後、 **読み取り専用ファイルシステム**. 読み取り/書き込みを行う特定のマウントポイントを設定できます。 サーバーに FTP で接続したり、モジュールを追加することはできません。 代わりに、ローカルリポジトリにコードを追加して、を実行する必要があります。 `git push`：環境を構築およびデプロイします。 プロジェクト構造については、 [ローカルプロジェクトディレクトリ構造](../project/file-structure.md).

### フェーズ 3：スラッグの準備

ビルドフェーズの結果は、読み取り専用のファイルシステムで、 _スラッグ_. このフェーズでは、アーカイブが作成され、スラッグが永続的なストレージに配置されます。 次回コードをプッシュする際に、サービスが変更されなかった場合は、アーカイブのスラッグが使用されます。

- 変更されていないコードを再利用することで、継続的な統合の構築を高速化
- コードが変更された場合、は次のビルドを再利用するためにスラッグを更新します。
- 必要に応じて、デプロイメントを即座に元に戻すことが可能
- 静的ファイルを含める場合、 `app/etc/config.php` ファイルがコードベース内に存在します

スラッグには、すべてのファイルとフォルダーが含まれます **次を除く** 次の場所で構成されたマウント： `magento.app.yaml`:

- `"var": "shared:files/var"`
- `"app/etc": "shared:files/etc"`
- `"pub/media": "shared:files/media"`
- `"pub/static": "shared:files/static"`

### フェーズ 4：スラグとクラスタのデプロイ

お使いのアプリケーションとすべて [backend](https://experienceleague.adobe.com/docs/commerce-operations/operational-playbook/glossary.html) 次に示すサービスの提供：

- 各サービスをコンテナ (Web サーバー、OpenSearch、 [!DNL RabbitMQ]
- 読み取り/書き込み可能なファイル・システムをマウントします（高可用性の分散ストレージ・グリッドにマウント）。
- サービスが相互に（および相互にのみ）認識できるようにネットワークを構成します

>[!NOTE]
>
>すべてのビルドとデプロイメントが完了し、再度プッシュしたら、Git ブランチで変更をおこないます。 すべての環境ファイルシステムは、 _読み取り専用_. 読み取り専用システムは、プロセスがファイルシステムに書き込めないので、決定論的な展開を保証し、サイトのセキュリティを大幅に向上させます。 また、統合、ステージング、実稼動の各環境でコードが同一であることを確認するためにも機能します。

### フェーズ 5：デプロイメントフック

>[!NOTE]
>
>このフェーズでは、 [!DNL Commerce] アプリケーションがメンテナンスモードになり、デプロイメントが完了するまで。

最後の手順では、デプロイメントスクリプトを実行します。これを使用して、開発環境でデータを匿名化し、キャッシュを消去し、外部の継続的統合ツールに対してクエリを実行できます。 このスクリプトを実行すると、Redis など、環境内のすべてのサービスにアクセスできます。

次の場合、 `app/etc/config.php` ファイルがコードベースに存在しないので、静的ファイルは `gzip` とは、このフェーズでデプロイされ、デプロイフェーズとサイトメンテナンスの時間が長くなります。

>[!NOTE]
>
>参照： [変数をデプロイ](../environment/variables-deploy.md) ファイル圧縮のカスタマイズと無効化について説明します。

デプロイフックは 2 つあります。 The `pre-deploy.php` フックは、ビルドフックで生成されたリソースとコードの必要なクリーンアップと取得を完了します。 The `php ./vendor/bin/ece-tools deploy` hook は、一連のコマンドとスクリプトを実行します。

- Adobe Commerceが **インストールされていません**、でインストールされます。 `bin/magento setup:install`を使用して、デプロイメント設定を更新します。 `app/etc/env.php`、および Redis や Web サイトの URL など、指定した環境のデータベース。 **重要：** 完了時に、 [初回のデプロイメント](https://experienceleague.adobe.com/docs/commerce-cloud-service/user-guide/launch/overview.html) セットアップ中に、Adobe Commerceがすべての環境にインストールされ、デプロイされました。

- If Adobe Commerce **がインストールされている**&#x200B;必要に応じて、アップグレードを実行します。 デプロイメントスクリプトが実行されます `bin/magento setup:upgrade` データベーススキーマとデータ（拡張機能またはコアコードの更新後に必要）を更新し、デプロイメント設定も更新する場合。 `app/etc/env.php`、およびお使いの環境用のデータベース。 最後に、デプロイメントスクリプトが Adobe Commerce のキャッシュをクリアします。

- スクリプトは、オプションで、コマンドを使用して静的 Web コンテンツを生成します `magento setup:static-content:deploy`.

- スコープ (`-s` フラグを設定する )、デフォルトの設定 ( `quick` 静的コンテンツ展開戦略用。 環境変数を使用して戦略をカスタマイズできます [`SCD_STRATEGY`](../environment/variables-deploy.md#scd_strategy). これらのオプションと機能について詳しくは、 [静的ファイルのデプロイメント戦略](../deploy/static-content.md) そして `-s` ～に旗を掲げる [静的ビューファイルのデプロイ](https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cli/static-view/static-view-file-deployment.html).

>[!NOTE]
>
>デプロイスクリプトは、 `.magento` ディレクトリに移動した後、スクリプトはディレクトリとその内容を削除します。 お使いのローカル開発環境は影響を受けません。

### デプロイ後：ルーティングの設定

デプロイメントの実行中、プロセスは、新しく作成したクラスターに Web トラフィックが到達するように、エントリポイントでの受信トラフィックを 60 秒間停止し、ルーティングを再設定します。

デプロイが成功すると、メンテナンスモードが削除され、通常のアクセスが可能になり、次の場合にバックアップ (BAK) ファイルが作成されます。 `app/etc/env.php` そして `app/etc/config.php` 設定ファイル。

次を使用して静的コンテンツを生成する `SCD_ON_DEMAND` 変数を参照し、 [`post_deploy` フック](../application/hooks-property.md) キャッシュをクリアし、キャッシュをプリロード (warms) します。 _次より後_ コンテナが接続を受け入れ始め、 _期間_ 通常の、着信トラフィック。

ビルドログとデプロイログを確認するには、 [ログを表示](../test/log-locations.md#view-and-manage-logs).
